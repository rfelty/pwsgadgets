<?xml version="1.0" encoding="UTF-8" ?>
<Module>
	<ModulePrefs title="__UP_title__" 
							 description="This gadget provides you with your Personal Weather Station updated data from wunderground.com." 
							 author="Jordi Morell"
							 author_email="pwsgadgets.feedback@gmail.com" 
							 author_location="Palma de Mallorca, Spain"
							 thumbnail="http://icons.wunderground.com/graphics/logos/full_4c_gradient.jpg"
							 screenshot="http://icons.wunderground.com/graphics/logos/full_4c_gradient.jpg"
							 title_url="http://pwsgadgets.googlecode.com" 
							 directory_title="Weather underground PWS current conditions." 
							 height="260"
							 scaling="true"
							 singleton="false"
							 scrolling="true">
		<Require feature="analytics"/>
		<Require feature="tabs"/>
	</ModulePrefs>
	<UserPref name="wnd_id" display_name="Wunderground station id" required="true"/>
	<UserPref name="wnd_units" datatype="enum" display_name="Units" default_value="metric" required="true">
		<EnumValue value="metric" display_value="Metric" />
		<EnumValue value="english" display_value="English" />
		<EnumValue value="both" display_value="Both" />
	</UserPref>
	<UserPref name="update_timer" datatype="enum" display_name="Update every: " default_value="30000" required="true">
		<EnumValue value="30000" display_value="30 seconds" />
		<EnumValue value="60000" display_value="1 minute" />
		<EnumValue value="120000" display_value="2 minutes" />
		<EnumValue value="180000" display_value="3 minutes" />
		<EnumValue value="240000" display_value="4 minutes" />
		<EnumValue value="300000" display_value="5 minutes" />
	</UserPref>
	<UserPref name="show_dewpoint" display_name="Dew point:" datatype="bool" default_value="true"/>
	<UserPref name="show_humidity" display_name="Relative humidity:" datatype="bool" default_value="true"/>
	<UserPref name="show_wind" display_name="Wind:" datatype="bool" default_value="true"/>
	<UserPref name="show_pressure" display_name="Pressure:" datatype="bool" default_value="true"/>
	<UserPref name="show_1hrain" display_name="1 hour rain:" datatype="bool" default_value="true"/>
	<UserPref name="show_todayrain" display_name="Today rain:" datatype="bool" default_value="true"/>
	<UserPref name="title" display_name="Title" required="true" default_value="Current conditions"/>
	<Content type="html">
		<![CDATA[
			<div id="current__MODULE_ID__" style="font-size:10pt; padding:5px; color: black; text-align: left;">Fetching xml...</div>
			<div id="hints__MODULE_ID__" style="font-size:9pt; padding:5px; color: gray; text-align: left;"></div>
			<div id="about__MODULE_ID__" style="font-size:10pt; padding:5px; color: gray; text-align: left;"></div>
			<div id="footer" style="font-size:7pt; padding:5px; color: gray; text-align: right;"></div>
			<script type="text/javascript">
			  // version variable
				var version = "v2.1.2";
				// Current conditions tab id
				var currentTabId = "current__MODULE_ID__";
				// Extreme values tab id
				//extremeTabId = "extreme__MODULE_ID__";
				// Hints tab id
				var hintsTabId = "hints__MODULE_ID__";				
				// About tab id
				var aboutTabId = "about__MODULE_ID__";
				// Initialize tabs.
				var tabs = new _IG_Tabs(__MODULE_ID__, "Current");
				// Track this gadget using Google Analytics specifiying the wunder id used.
				_IG_Analytics("UA-3007781-2", "/CurrentConditions/" + new _IG_Prefs(__MODULE_ID__).getString("wnd_id"));
			
				// Init function.
				function init() {
					// Add the gadget tabs.
					tabs.addTab("Current", currentTabId, displayCurrentTab);
					//tabs.addTab("Extreme", extremeTabId, displayExtremeTab);
					tabs.addTab("Hints", hintsTabId, displayHintsTab);
					tabs.addTab("About", aboutTabId, displayAboutTab);
					_gel("footer").innerHTML = version;
				}
				
				// Create 'Current' tab html.
				function displayCurrentConditionsHtml(xml) {
					_gel(currentTabId).innerHTML = "";
					var prefs = new _IG_Prefs(__MODULE_ID__);
					var units = prefs.getString("wnd_units");
					var html = ""; 
					// Display metric units.
					if (xml.getElementsByTagName("station_id")[0].firstChild == null) {
						html += "<b>Invalid wunderground station id.</b><br>Please visit <a href='http://www.wunderground.com/weatherstation/index.asp' target='_blank'>Personal Weather Stations Weather Underground</a> site to get more info."
					} else {
						var latitude = xml.getElementsByTagName("latitude")[0].firstChild.data;
						var longitude = xml.getElementsByTagName("longitude")[0].firstChild.data;
						_IG_FetchXmlContent(getForecastURL(latitude, longitude), displayCurrentIconHtml);
						if (xml.getElementsByTagName("neighborhood")[0].firstChild != null) {	html += xml.getElementsByTagName("neighborhood")[0].firstChild.data + " "; }
						if (units == "metric") {
							if (xml.getElementsByTagName("temp_c")[0].firstChild != null) { html += xml.getElementsByTagName("temp_c")[0].firstChild.data + " ºC"; }
							html += "</h3></center>";
							if (xml.getElementsByTagName("dewpoint_c")[0].firstChild != null && prefs.getBool("show_dewpoint")==true) { html += "Dew point: " + xml.getElementsByTagName("dewpoint_c")[0].firstChild.data + " ºC<br>"; }
							if (xml.getElementsByTagName("relative_humidity")[0].firstChild != null && prefs.getBool("show_humidity")==true) { html += "Relative Humidity: " + xml.getElementsByTagName("relative_humidity")[0].firstChild.data + "%<br>"; }
							if (xml.getElementsByTagName("wind_degrees")[0].firstChild != null && xml.getElementsByTagName("wind_mph")[0].firstChild != null && xml.getElementsByTagName("wind_gust_mph")[0].firstChild != null && prefs.getBool("show_wind")==true) { html += "Wind: " + lookupWindString(xml.getElementsByTagName("wind_degrees")[0].firstChild.data) + " at " + parseInt(parseFloat(xml.getElementsByTagName("wind_mph")[0].firstChild.data) * 1.61) + " km/h gusting to " + parseInt(parseFloat(xml.getElementsByTagName("wind_gust_mph")[0].firstChild.data) * 1.61) + " km/h<br>"; }
							if (xml.getElementsByTagName("pressure_mb")[0].firstChild != null && prefs.getBool("show_pressure")==true) { html += "Pressure: " + xml.getElementsByTagName("pressure_mb")[0].firstChild.data + " mb<br>"; }
							if (xml.getElementsByTagName("precip_1hr_metric")[0].firstChild != null && prefs.getBool("show_1hrain")==true) { html += "1 Hour Rain: " + xml.getElementsByTagName("precip_1hr_metric")[0].firstChild.data + " mm<br>"; }
							if (xml.getElementsByTagName("precip_today_metric")[0].firstChild != null && prefs.getBool("show_todayrain")==true) { html += "Today Rain: " + xml.getElementsByTagName("precip_today_metric")[0].firstChild.data + " mm<br>"; }
						} else if (units == "english") {
							if (xml.getElementsByTagName("temp_f")[0].firstChild != null) { html += xml.getElementsByTagName("temp_f")[0].firstChild.data + " F"; }
							html += "</h3></center>";
							if (xml.getElementsByTagName("dewpoint_f")[0].firstChild != null && prefs.getBool("show_dewpoint")==true) { html += "Dew point: " + xml.getElementsByTagName("dewpoint_f")[0].firstChild.data + " F<br>"; }
							if (xml.getElementsByTagName("relative_humidity")[0].firstChild != null && prefs.getBool("show_humidity")==true) { html += "Relative Humidity: " + xml.getElementsByTagName("relative_humidity")[0].firstChild.data + "%<br>"; }
							if (xml.getElementsByTagName("wind_degrees")[0].firstChild != null && xml.getElementsByTagName("wind_mph")[0].firstChild != null && xml.getElementsByTagName("wind_gust_mph")[0].firstChild != null && prefs.getBool("show_wind")==true) { html += "Wind: " + lookupWindString(xml.getElementsByTagName("wind_degrees")[0].firstChild.data) + " at " + parseFloat(xml.getElementsByTagName("wind_mph")[0].firstChild.data) + " mph gusting to " + parseFloat(xml.getElementsByTagName("wind_gust_mph")[0].firstChild.data) + " mph<br>"; }						
							if (xml.getElementsByTagName("pressure_in")[0].firstChild != null && prefs.getBool("show_pressure")==true) { html += "Pressure: " + xml.getElementsByTagName("pressure_in")[0].firstChild.data + " in<br>"; }
							if (xml.getElementsByTagName("precip_1hr_in")[0].firstChild != null && prefs.getBool("show_1hrain")==true) { html += "1 Hour Rain: " + xml.getElementsByTagName("precip_1hr_in")[0].firstChild.data + " in<br>"; }
							if (xml.getElementsByTagName("precip_today_in")[0].firstChild != null && prefs.getBool("show_todayrain")==true) { html += "Today Rain: " + xml.getElementsByTagName("precip_today_in")[0].firstChild.data + " in<br>"; }
						} else if (units == "both") {
							if (xml.getElementsByTagName("temp_f")[0].firstChild != null && xml.getElementsByTagName("temp_c")[0].firstChild != null) { html += xml.getElementsByTagName("temp_f")[0].firstChild.data + " F (" + xml.getElementsByTagName("temp_c")[0].firstChild.data + "ºC)"; }
							html += "</h3></center>";
							if (xml.getElementsByTagName("dewpoint_f")[0].firstChild != null && xml.getElementsByTagName("dewpoint_c")[0].firstChild != null && prefs.getBool("show_dewpoint")==true) { html += "Dew point: " + xml.getElementsByTagName("dewpoint_f")[0].firstChild.data + " F (" + xml.getElementsByTagName("dewpoint_c")[0].firstChild.data + "ºC)<br>"; }
							if (xml.getElementsByTagName("relative_humidity")[0].firstChild != null && prefs.getBool("show_humidity")==true) { html += "Relative Humidity: " + xml.getElementsByTagName("relative_humidity")[0].firstChild.data + "%<br>"; }
							if (xml.getElementsByTagName("wind_degrees")[0].firstChild != null && xml.getElementsByTagName("wind_mph")[0].firstChild != null && xml.getElementsByTagName("wind_gust_mph")[0].firstChild != null && prefs.getBool("show_wind")==true) { html += "Wind: " + lookupWindString(xml.getElementsByTagName("wind_degrees")[0].firstChild.data) + " at " + parseFloat(xml.getElementsByTagName("wind_mph")[0].firstChild.data) + " mph (" + parseInt(parseFloat(xml.getElementsByTagName("wind_mph")[0].firstChild.data) * 1.61) + " km/h) gusting to " + parseFloat(xml.getElementsByTagName("wind_gust_mph")[0].firstChild.data) + " mph ("+ parseInt(parseFloat(xml.getElementsByTagName("wind_gust_mph")[0].firstChild.data) * 1.61) + " km/h)<br>"; }						
							if (xml.getElementsByTagName("pressure_in")[0].firstChild != null && xml.getElementsByTagName("pressure_mb")[0].firstChild != null && prefs.getBool("show_pressure")==true) { html += "Pressure: " + xml.getElementsByTagName("pressure_in")[0].firstChild.data + " in (" + xml.getElementsByTagName("pressure_mb")[0].firstChild.data + " mb)<br>"; }
							if (xml.getElementsByTagName("precip_1hr_in")[0].firstChild != null && xml.getElementsByTagName("precip_1hr_metric")[0].firstChild != null && prefs.getBool("show_1hrain")==true) { html += "1 Hour Rain: " + xml.getElementsByTagName("precip_1hr_in")[0].firstChild.data + " in (" + xml.getElementsByTagName("precip_1hr_metric")[0].firstChild.data + " mm)<br>"; }
							if (xml.getElementsByTagName("precip_today_in")[0].firstChild != null && xml.getElementsByTagName("precip_today_metric")[0].firstChild != null && prefs.getBool("show_todayrain")==true) { html += "Today Rain: " + xml.getElementsByTagName("precip_today_in")[0].firstChild.data + " in (" + xml.getElementsByTagName("precip_today_metric")[0].firstChild.data + " mm)<br>"; }
						}
						html += "Last updated: " + new Date().toLocaleString();
					}
					// Display HTML string
					if (_gel(currentTabId).innerHTML.indexOf("img",0) == -1) {
						_gel(currentTabId).innerHTML = "<center><h3>" + html;
					} else {
						_gel(currentTabId).innerHTML = "<center><h3>" + _gel(currentTabId).innerHTML + html;					
					}
					// Set the timeout
					setTimeout("displayCurrentTab()", prefs.getInt("update_timer"));
				}

				// Gets the current conditions icon url.
				function displayCurrentIconHtml(xml) {
					var img = "";
					var html = "";
					var sunsetHour = xml.getElementsByTagName("sunset")[0].getElementsByTagName("hour")[0].firstChild.data;
					var sunsetMinutes = xml.getElementsByTagName("sunset")[0].getElementsByTagName("minute")[0].firstChild.data;
					var now = new Date();
					var sunset = new Date();
					sunset.setHours(sunsetHour);
					sunset.setMinutes(sunsetMinutes);
					if (xml.getElementsByTagName("icon")[0].firstChild != null) {
						img += "<img style='vertical-align:middle' src='http://icons.wunderground.com/graphics/conds/"
						if (sunset.getTime() - now.getTime() > 0) {
							img += xml.getElementsByTagName("icon")[0].firstChild.data;
						} else {
							img += "nt_" + xml.getElementsByTagName("icon")[0].firstChild.data;
						}
						img += ".gif' height='42' width='42'>&nbsp;&nbsp;";
					}
					// Display HTML string
					if (_gel(currentTabId).innerHTML.indexOf("center",0) == -1) {
						_gel(currentTabId).innerHTML = img;
					} else {
						html = _gel(currentTabId).innerHTML.substr(12);
						_gel(currentTabId).innerHTML = "<center><h3>" + img + html;
					}
				}
				
				// Create 'Hints' tab html.
				function displayHintsHtml(xml) {
					var html = "<ul>"; 
					// If the station_id is not correct.
					if (xml.getElementsByTagName("station_id")[0].firstChild == null) {
						html += "<li><b>Invalid wunderground station id.</b>Please visit <a href='http://www.wunderground.com/weatherstation/index.asp' target='_blank'>Personal Weather Stations Weather Underground</a> site to get more info.</li>";
					} else {
						// Check if weather undergroung has updated info.
						if (xml.getElementsByTagName("observation_time_rfc822")[0].firstChild != null) {
							var observationTime = Date.parse(xml.getElementsByTagName("observation_time_rfc822")[0].firstChild.data);
							var notUpdated = new Date().getTime() - observationTime;
							// If the info is not updated for more than 10 minutes show an alarm.
							if (notUpdated > 600000) { html += "<li><b>Your personal weather station have not sent any information to Weather Underground for more than " + parseInt(((notUpdated/1000)/60)) + " minutes. Please check your station is propertly configured to upload data to Weather Underground.</b></li>"; }
						}
						// If the neightborhood info is not at wunderground.
						if (xml.getElementsByTagName("neighborhood")[0].firstChild == null) {	html += "<li>If you want to see your neighborhood information next to the temperature in the 'Current' tab, please complete your Personal Weather Station info at <a href='http://www.wunderground.com/wxstation/signup.html' target='_blank'>Weather Underground</a> web site.</li>"; }
					}
					html += "<li>Get CurrentConditions gadget updated information at <a href='http://code.google.com/p/pwsgadgets/wiki/CurrentConditions' target='_blank'>CurrentConditions gadget page</a>.</li>";
					html += "<li>Get more gadgets for your personal weather station at PWS Gadgets project <a href='http://pwsgadgets.googlecode.com/' target='_blank'>home page</a></li>";
					html += "<li>See your Personal Weather Station History at <a href='http://www.wunderground.com/weatherstation/WXDailyHistory.asp?ID=IISLASBA11' target='_blank'>Weather Underground</a>.</li>"
					html += "</ul>";
					// Display HTML string
					_gel(hintsTabId).innerHTML = html;
					// Set the timeout
					setTimeout("displayHintsTab()", 300000);
				}
				
				// Outputs the wind direction string from the degrees
				function lookupWindString(n) {
					var s="-";
					if (n > 360) n = n%360;
					if (n >= 0 && n < 11.25 ) s="N";
					else if (n >= 11.25  && n < 33.75 ) s="NNE";
					else if (n >= 33.75  && n < 56.25 ) s="NE";
					else if (n >= 67.5   && n < 78.75 ) s="ENE";
					else if (n >= 78.75  && n < 101.25) s="E";
					else if (n >= 101.25 && n < 123.75) s="ESE";
					else if (n >= 123.75 && n < 146.25) s="SE";
					else if (n >= 146.2  && n < 168.75) s="SSE";
					else if (n >= 168.75 && n < 191.25) s="S";
					else if (n >= 191.25 && n < 213.75) s="SSW";
					else if (n >= 213.75 && n < 236.25) s="SW";
					else if (n >= 236.25 && n < 258.75) s="WSW";
					else if (n >= 258.75 && n < 281.25) s="W";
					else if (n >= 281.25 && n < 303.75) s="WNW";
					else if (n >= 303.75 && n < 326.25) s="NW";
					else if (n >= 326.25 && n < 348.75) s="NNW";
					else if (n >= 348.75) s="N";
					return s;
				}

				// Gets the Weather Underground Current Conditions URL.
				function getCurrentConditionsUrl() {
					return "http://api.wunderground.com/weatherstation/WXCurrentObXML.asp?ID=" + new _IG_Prefs(__MODULE_ID__).getString("wnd_id") + "&rnd=" + Math.random();
				}
				
				// Gets the Weather Underground forecast URL.
				function getForecastURL(latitude, longitude) {
					return url = "http://api.wunderground.com/auto/wui/geo/ForecastXML/index.xml?query=" + latitude + "," + longitude;
				}
				
				function displayCurrentTab(tabId) {
					_IG_FetchXmlContent(getCurrentConditionsUrl(), displayCurrentConditionsHtml);
				}

				function displayExtremeTab(tabId) {

				}

				function displayHintsTab(tabId) {
					_IG_FetchXmlContent(getCurrentConditionsUrl(), displayHintsHtml);
				}

				function displayAboutTab(tabId) {
					var html = "<center><h3>" + version + "</h3></center>";
					html += "<ul>";
					html += "<li>CurrentConditions gadget <a href='http://code.google.com/p/pwsgadgets/wiki/CurrentConditions' target='_blank'>help page.</a></li>";
					html += "<li>Feel free to write any feedback to <a href='mailto:pwsgadgets.feedback@gmail.com'>pwsgadgets.feedback@gmail.com</a></li>"
					html += "</ul>";
					_gel(tabId).innerHTML = html;
				}

				_IG_RegisterOnloadHandler(init);
			</script>
		]]> 
	</Content> 
</Module>