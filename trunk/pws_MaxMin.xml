<?xml version="1.0" encoding="UTF-8" ?>
<Module>
<ModulePrefs title="__UP_title__" 
						 description="Customizable max min values retrieval from wunderground web site." 
						 author="Jordi Morell" author_email="nospam.hokus04@gmail.com" 
						 title_url="http://www.wunderground.com" 
						 directory_title="Wunderground Max Min Values." 
						 category="weather" 
						 height="50"/>
	<UserPref name="wnd_id" display_name="Wunderground station id" required="true"/>
	<UserPref name="value" datatype="enum" display_name="Value to check" default_value="temp_c" required="true">
		<EnumValue value="temp_c" display_value="Temperature ºC" />
		<EnumValue value="temp_f" display_value="Temperature F" />
		<EnumValue value="relative_humidity" display_value="Relative Humidity" />
		<EnumValue value="wind_degrees" display_value="Wind Degrees" />
		<EnumValue value="wind_mph" display_value="Wind mph" />
		<EnumValue value="wind_gust_mph" display_value="Wind Gust mph" />
		<EnumValue value="wind_kmh" display_value="Wind km/h" />
		<EnumValue value="wind_gust_kmh" display_value="Wind Gust km/h" />
		<EnumValue value="pressure_mb" display_value="Pressure mb" />
		<EnumValue value="pressure_in" display_value="Pressure in" />
		<EnumValue value="dewpoint_c" display_value="Dew Point ºC" />
		<EnumValue value="dewpoint_f" display_value="Dew Point F" />
		<EnumValue value="precip_1hr_metric" display_value="1 hour rain (cm)" />
		<EnumValue value="precip_1hr_in" display_value="1 hour rain (in)" />
		<EnumValue value="precip_today_metric" display_value="Today rain (cm)" />
		<EnumValue value="precip_today_in" display_value="Today rain (in)" />
	</UserPref>
	<UserPref name="show_time" datatype="enum" display_name="Show time" default_value="yes" required="true">
		<EnumValue value="yes" display_value="Yes" />
		<EnumValue value="no" display_value="No" />
	</UserPref>
	<UserPref name="title" display_name="Title" required="true"/>
	<Content type="html">
		<![CDATA[
			<div id="maxmin__MODULE_ID__" style="font-size:12pt; padding:5px; color: black;">Reading xml...</div>
			<div id="debug_div" style="font-size:9pt; padding:5px; color: red;"></div>

			<script type="text/javascript">
					// debug flag. When its value is non-zero, debugging messages are displayed
      		var debug = 0;
      		// The string containing debugging messages
      		var debug_html = "";			
				function displayMenu() {
				  this.name = 'maxmin__MODULE_ID__';
					var prefs = new _IG_Prefs(__MODULE_ID__);
					var wunderID = prefs.getString("wnd_id");
					var checkValue = prefs.getString("value");
					var showTime = prefs.getString("show_time");
					var url = "http://api.wunderground.com/weatherstation/WXDailyHistory.asp?ID=" + wunderID + "&format=XML&rnd=" + Math.random();
					print(url);
					_IG_FetchXmlContent(url, function (response) {
						if (response == null || typeof(response) != "object" || response.firstChild == null) {
							_gel(this.name).innerHTML = "<i>Invalid data.</i>";
					  	return;
						}
					var html = ""; 
					var maxData = -10000; 
					var minData = 10000;     
					var maxDataTime = "";
					var minDataTime = "";
					var data = 0;
					var observationList = response.getElementsByTagName("current_observation");					
					var wunderField = "";
					if (checkValue == "wind_kmh") {
						wunderField = "wind_mph";
					} else if (checkValue == "wind_gust_kmh") {
						wunderField = "wind_gust_mph";
					} else {
						wunderField = checkValue;
					}
					print(wunderField);
					for (var i = 0; i < observationList.length ; i++) { 
						data = parseFloat(observationList[i].getElementsByTagName(wunderField)[0].firstChild.data);
						if (data > maxData) {                    
							maxData = data;
							maxDataTime = observationList[i].getElementsByTagName("observation_time")[0].firstChild.data;
							maxDataTime = maxDataTime.substr(maxDataTime.indexOf(",") + 2, maxDataTime.length);
						}                      
						if (data < minData) {  
							minData = data;
							minDataTime = observationList[i].getElementsByTagName("observation_time")[0].firstChild.data;
							minDataTime = minDataTime.substr(minDataTime.indexOf(",") + 2, minDataTime.length);
						}
						print(data + " High " + maxData + " Low " + minData);
					}
					if (showTime == "yes") {
						html += "High: " + getUnits(checkValue, maxData) + " at " + maxDataTime;
						html += "<br>"; 
						html += "Low: " + getUnits(checkValue, minData) + " at " + minDataTime;
					} else {
						html += "High: " + getUnits(checkValue, maxData);
						html += "<br>"; 
						html += "Low: " + getUnits(checkValue, minData);
					}
					// Display HTML string
					_gel(this.name).innerHTML = html;
					}, { refreshInterval: (60 * 4)});	
				}
				// Outputs debug messages if debug flag has a non-zero value
				function print(msg) {
					if (debug) {
						debug_html += msg + "<br>";
						// Write debug HTML to div
						_gel("debug_div").innerHTML = debug_html; 
					}
				}
				
				function getUnits(field, value) {
					if (field == "wind_kmh") {	return (parseFloat(value) * 1.61) + " km/h";	}
					else if (field == "wind_gust_kmh") {	return (parseFloat(value) * 1.61) + " km/h"; }
					else if (field == "temp_c"){ return value + " ºC";}
					else if (field == "temp_f"){ return value + " F";}
					else if (field == "relative_humidity"){ return value + "%";}
					else if (field == "wind_degrees"){ return value + "º";}
					else if (field == "wind_mph"){ return value + " mph";}
					else if (field == "wind_gust_mph"){ return value + " mph";}
					else if (field == "pressure_mb"){ return value + " mb";}
					else if (field == "pressure_in"){ return value + " in";}
					else if (field == "dewpoint_c"){ return value + " ºC";}
					else if (field == "dewpoint_f"){ return value + " F";}
					else if (field == "precip_1hr_metric"){ return value + " mm";}
					else if (field == "precip_1hr_in"){ return value + " in";}
					else if (field == "precip_today_metric"){ return value + " mm";}
					else if (field == "precip_today_in"){ return value + " in";}					
				}
				_IG_RegisterOnloadHandler(displayMenu);  
			</script>
		]]> 
	</Content> 
</Module>